const moles = document.querySelectorAll('.mole');
  const scoreEl = document.getElementById('score');
  const timeEl = document.getElementById('time');
  const restartBtn = document.getElementById('restartBtn');
  const gameOverEl = document.getElementById('gameOver');
  const sound = document.getElementById('hitSound');

  let score = 0;
  let timeLeft = 30;
  let currentHole = -1;
  let gameActive = false; // å¢åŠ ä¸€å€‹éŠæˆ²ç‹€æ…‹é–
  let moleTimer = null;
  let timeTimer = null;

  function getSpeed() {
    // éš¨æ©Ÿä¸€å€‹å‡ºç¾æ™‚é–“ï¼Œéš¨è‘—åˆ†æ•¸å¢åŠ è€Œç¸®çŸ­ä¸Šé™
    const minTime = 400;
    const maxTime = Math.max(600, 1200 - score * 30);
    return Math.floor(Math.random() * (maxTime - minTime) + minTime);
  }

  function showMole() {
    if (!gameActive) return;

    // æ¸…é™¤æ‰€æœ‰åœ°é¼ ç‹€æ…‹
    moles.forEach(m => {
      m.style.display = 'none';
      m.classList.remove('clicked'); // ç§»é™¤å·²é»æ“Šæ¨™è¨˜
    });

    let next;
    do {
      next = Math.floor(Math.random() * moles.length);
    } while (next === currentHole);
    
    currentHole = next;
    moles[currentHole].style.display = 'block';

    // ä½¿ç”¨ setTimeout éè¿´å‘¼å«ï¼Œé€™æ¨£æ¯æ¬¡çš„é€Ÿåº¦éƒ½èƒ½æ ¹æ“šæœ€æ–°åˆ†æ•¸å‹•æ…‹èª¿æ•´
    moleTimer = setTimeout(showMole, getSpeed());
  }

  moles.forEach(mole => {
    mole.addEventListener('click', function() {
      // æª¢æŸ¥ï¼šéŠæˆ²æ˜¯å¦çµæŸã€åœ°é¼ æ˜¯å¦å¯è¦‹ã€æ˜¯å¦å·²ç¶“é»é
      if (!gameActive || this.style.display === 'none' || this.classList.contains('clicked')) {
        return;
      }

      // æ¨™è¨˜ç‚ºå·²é»æ“Šï¼Œé˜²æ­¢é‡è¤‡è¨ˆç®—
      this.classList.add('clicked');
      score++;
      scoreEl.textContent = score;
      
      // æ’­æ”¾éŸ³æ•ˆ
      sound.currentTime = 0;
      sound.play();

      // é»æ“Šå¾Œç«‹å³éš±è—ï¼Œå¢åŠ å›é¥‹æ„Ÿ
      this.style.display = 'none';
    });
  });

  function startGame() {
    // åˆå§‹åŒ–æ•¸æ“š
    score = 0;
    timeLeft = 30;
    gameActive = true;
    scoreEl.textContent = score;
    timeEl.textContent = timeLeft;
    gameOverEl.style.display = 'none';

    // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
    clearTimeout(moleTimer);
    clearInterval(timeTimer);

    // é–‹å§‹è·‘åœ°é¼ 
    showMole();

    // å€’æ•¸è¨ˆæ™‚
    timeTimer = setInterval(() => {
      timeLeft--;
      timeEl.textContent = timeLeft;
      if (timeLeft <= 0) endGame();
    }, 1000);
  }

  function endGame() {
    gameActive = false;
    clearTimeout(moleTimer);
    clearInterval(timeTimer);
    moles.forEach(m => m.style.display = 'none');
    gameOverEl.style.display = 'block';
    gameOverEl.textContent = `ğŸ® Game Over! æœ€çµ‚å¾—åˆ†ï¼š${score}`;
  }

  restartBtn.addEventListener('click', startGame);

  // åˆå§‹è¼‰å…¥
  window.addEventListener('load', startGame);
