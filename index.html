<script>
const moles = document.querySelectorAll('.mole');
const scoreEl = document.getElementById('score');
const timeEl = document.getElementById('time');
const restartBtn = document.getElementById('restartBtn');
const gameOverEl = document.getElementById('gameOver');
const sound = document.getElementById('hitSound');

let score = 0;
let highScore = Number(localStorage.getItem('highScore')) || 0;
let timeLeft = 30;
let current = -1;
let moleTimer = null;
let timeTimer = null;
let canHit = true;

// 建立最高分顯示
const highBox = document.createElement('span');
highBox.style.marginLeft = "10px";
highBox.innerHTML = `最高分：<span id="high">${highScore}</span>`;
scoreEl.parentNode.appendChild(highBox);
const highEl = document.getElementById('high');

function getSpeed() {
  return Math.max(300, 800 - score * 20);
}

function showMole() {
  canHit = true;
  moles.forEach(m => m.style.display = 'none');

  let next;
  do {
    next = Math.floor(Math.random() * moles.length);
  } while (next === current);

  current = next;
  moles[current].style.display = 'block';

  clearInterval(moleTimer);
  moleTimer = setInterval(showMole, getSpeed());
}

moles.forEach(mole => {
  mole.addEventListener('click', () => {
    if (!canHit || timeLeft <= 0) return;

    canHit = false;
    score++;
    scoreEl.textContent = score;
    mole.style.display = 'none';

    sound.currentTime = 0;
    sound.play();
  });
});

function startGame() {
  score = 0;
  timeLeft = 30;
  current = -1;

  scoreEl.textContent = score;
  timeEl.textContent = timeLeft;
  gameOverEl.style.display = 'none';

  moles.forEach(m => m.style.display = 'none');

  clearInterval(moleTimer);
  clearInterval(timeTimer);

  moleTimer = setInterval(showMole, getSpeed());

  timeTimer = setInterval(() => {
    timeLeft--;
    timeEl.textContent = timeLeft;
    if (timeLeft <= 0) endGame();
  }, 1000);
}

function endGame() {
  clearInterval(moleTimer);
  clearInterval(timeTimer);

  moles.forEach(m => m.style.display = 'none');
  gameOverEl.style.display = 'block';

  if (score > highScore) {
    highScore = score;
    localStorage.setItem('highScore', highScore);
    highEl.textContent = highScore;
  }
}

restartBtn.addEventListener('click', startGame);
window.addEventListener('load', startGame);
</script>
